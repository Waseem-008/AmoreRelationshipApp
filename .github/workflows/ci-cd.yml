name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Backend Tests
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        run: |
          npm install -g supabase
      
      - name: Verify Migrations
        run: |
          cd backend
          # Validate SQL syntax
          for file in supabase/migrations/*.sql; do
            echo "Checking $file"
            # Basic SQL validation (you can add more sophisticated checks)
            grep -q "create table\|alter table\|create index" "$file" || echo "Warning: $file may be empty"
          done
      
      - name: Test Edge Functions
        run: |
          cd backend/supabase/functions
          # Check TypeScript syntax
          for dir in */; do
            if [ -f "$dir/index.ts" ]; then
              echo "Validating $dir"
              # You can add deno check here if needed
            fi
          done

  # Admin Panel Tests
  admin-test:
    name: Admin Panel Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: admin-web/package-lock.json
      
      - name: Install Dependencies
        run: |
          cd admin-web
          npm ci
      
      - name: Lint
        run: |
          cd admin-web
          npm run lint || echo "Linting skipped (add linter to package.json)"
      
      - name: Build
        run: |
          cd admin-web
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

  # iOS Build Check (basic validation)
  ios-validation:
    name: iOS Validation
    runs-on: macos-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.0'
      
      - name: Verify Swift Files
        run: |
          cd ios/Amora/Amora
          # Check for Swift compilation errors (dry run)
          find . -name "*.swift" -exec swiftc -parse {} \; || echo "Swift validation completed"

  # Deploy to Staging (only on develop branch)
  deploy-staging:
    name: Deploy to Staging
    needs: [backend-test, admin-test]
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        run: npm install -g supabase
      
      - name: Deploy Backend
        run: |
          cd backend
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase db push
          supabase functions deploy --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Deploy Admin Panel to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: admin-web

  # Deploy to Production (only on main branch with tag)
  deploy-production:
    name: Deploy to Production
    needs: [backend-test, admin-test]
    if: github.ref == 'refs/heads/main' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        run: npm install -g supabase
      
      - name: Deploy Backend to Production
        run: |
          cd backend
          supabase link --project-ref ${{ secrets.SUPABASE_PRODUCTION_PROJECT_REF }}
          supabase db push
          supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      
      - name: Deploy Admin Panel to Production
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: admin-web
      
      - name: Create Release Notes
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
